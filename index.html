<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cost Averaging Calculator</title>
    <meta name="author" content="Victor Butler">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  </head>
  <body class="">
    <div id="app" class="container">
      <div class="row mt-2 mb-5">
        <h1 class="col-sm-12 text-center">Cost Average Calculator</h1>
      </div>
      <div class="row">
        <h2 class="col-sm-4">Starting with...</h2>
        <div class="col-sm-1 ml-auto">
          <a href="#data-sets-modal" data-toggle="modal" data-target="#data-sets-modal"><img src="icons/gear.svg" width="30" height="30" alt="Configure"></a>
        </div>
      </div>
      <form>
        <div class="row mt-5 mb-5">
          <div class="col-sm-4">
            <div class="row">
              <label for="initial-amount" class="h5 col text-right">Coin Amount</label>
              <input type="text" class="col" name="initial-amount" id="initial-amount" size="12" />
            </div>
          </div>
          <div class="col-sm-4">
            <div class="row">
              <label for="initial-price" class="h5 col text-right">Coin Price</label>
              <input type="text" class="col" name="initial-price" id="initial-price" size="12" />
            </div>
          </div>
          <div class="col-sm-4">
            <div class="row">
              <label for="projected-profit" class="h5 col text-right">Projected Profit</label>
              <div class="col-sm-4 input-group">
                <input type="text" class="form-control" name="projected-profit" id="projected-profit" size="3" />
                <div class="input-group-append">
                  <span class="input-group-text">%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row col-sm-4">
          <h2>Cost Average Levels</h2>
        </div>
        <div class="row mt-4">
          <div class="col-sm-12">
            <label for="levels" class="h5">Levels</label>
            <select name="levels" id="levels">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
              <option value="11">11</option>
              <option value="12">12</option>
              <option value="13">13</option>
              <option value="14">14</option>
              <option value="15">15</option>
            </select>
          </div>
        </div>
        <table class="table cost-averaging-results mt-5">
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">Coins to buy</th>
              <th scope="col">Price of coins</th>
              <th scope="col">Average Price</th>
              <th scope="col">Sell Price</th>
              <th scope="col">Profit</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </form>
      <div id="data-sets-modal" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Data Sets</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="row">
                <div class="col-sm-12 alert alert-danger" role="alert" style="display: none;">
                  Fill out the form and enter a name to save the data as.
                </div>
              </div>
              <div class="row">
                <div class="col-sm-8">
                  <input type="text" class="col" name="save-name" id="save-name" placeholder="Data Set Name" />
                </div>
                <div class="col-sm-2">
                  <button id="save-button" name="save-button" type="button" class="btn btn-primary">Save</button>
                </div>
              </div>
              <hr />
              <div class="row mt-3">
                <div class="col-sm-6 text-right">
                  <label for="data-sets-list">Saved Data Sets</label>
                  <select name="data-sets-list" id="data-sets-list"></select>
                </div>
                <div class="col-sm-6">
                  <button id="load-data-set" name="load-data-set" type="button" class="btn btn-secondary">Load</button>
                  <button id="delete-data-set" name="delete-data-set" type="button" class="btn btn-danger">Delete</button>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
      <footer class="text-muted small">
        <hr />
        <div class="row">
          <div class="col-sm-4">
            &copy; 2018 Victor Butler, <a target="_blank" href="https://github.com/victorbutler/cost-average-calculator/blob/master/LICENSE">MIT Licensed</a>
          </div>
          <div class="col-sm-4 ml-auto text-right">
            See more projects on <a target="_blank" href="https://github.com/victorbutler?tab=repositories">GitHub <img src="icons/octoface.svg" alt="GitHub" class="va-top"></a>
          </div>
        </div>
      </footer>
    </div>
    <!-- #PLUGINS -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/big.js/5.0.3/big.min.js"></script>
    <script type="text/javascript">
      $(function() {
        $('form').on('submit', function(e) {e.preventDefault();});
        var levelsHandler = function(e) {
          var levels = parseInt($('#levels').val());
          var levelsShown = $('table.cost-averaging-results tbody tr').length;
          var table = $('table.cost-averaging-results tbody');
          if (levels > levelsShown) {
            for (var i = levelsShown; i < levels; i++) {
              var tr = $('<tr />');
              tr.append('<th scope="row">' + (i + 1) + '</th>');
              var ca = $('<input type="text" size="12" />');
              ca.attr('name', 'coin-amount-' + (i + 1));
              tr.append($('<td />').append(ca));
              var cs = $('<input type="text" size="12" />');
              cs.attr('name', 'coin-price-' + (i + 1));
              tr.append($('<td />').append(cs));
              tr.append($('<td class="h5 text-primary average-price" />'));
              tr.append($('<td class="h5 text-info sell-price" />'));
              tr.append($('<td class="h5 text-success profit" />'));
              table.append(tr);
            }
          } else if (levels < levelsShown) {
            var rows = $('table.cost-averaging-results tbody tr');
            for (var i = rows.length; i > levels; i--) {
              rows.filter(':eq(' + (i - 1) + ')').remove();
            }
          }
        };
        $('#levels').on('change', levelsHandler);
        var calculate = function() {
          try {
            var coinsHeld = Big($('#initial-amount').val());
            var coinPrice = Big($('#initial-price').val());
            var profitRate = Big($('#projected-profit').val()).div(100);
            var averagePrice = coinPrice; // initially, avg price is initial price
            var rows = $('table.cost-averaging-results tbody tr');
            $('table.cost-averaging-results tbody tr').each(function(i, elm) {
              var $elm = $(elm);
                var coinAmount = Big($elm.find('input[name="coin-amount-' + (i + 1) + '"]').val());
                var coinPrice = Big($elm.find('input[name="coin-price-' + (i + 1) + '"]').val());
                //if (coinAmount.length && coinPrice.length) {
                  var newAveragePrice = averagePrice.times(coinsHeld).plus(coinPrice.times(coinAmount)).div(coinsHeld.plus(coinAmount));
                  var newSellPrice = newAveragePrice.times(profitRate.plus(1));
                  $elm.find('.average-price').text(newAveragePrice.round(8).toString());
                  $elm.find('.sell-price').text(newSellPrice.round(8).toString()).append(' <span data-toggle="tooltip" data-placement="top" title="' + newSellPrice.round(8).div(coinPrice).minus(1).times(100).round(2).toString() + '% of Price of coins"><img class="va-top" src="icons/question.svg" alt="Question" height="22" width="22"></span>').find('span').tooltip();
                  averagePrice = newAveragePrice;
                  coinsHeld = coinsHeld.plus(coinAmount);
                  $elm.find('.profit').text(coinsHeld.times(averagePrice).times(profitRate).round(8).toString());
                //}
            });
          } catch (e) {
          }
        };
        var captureFormState = function() {
          var data = {
            'name': $('#save-name').val(),
            'initial-amount': $('#initial-amount').val(),
            'initial-price': $('#initial-price').val(),
            'projected-profit': $('#projected-profit').val(),
            'levels': $('#levels').val()
          };
          var levelsData = [];
          for (var i = 1; i <= parseInt(data.levels); i++) {
            levelsData.push({
              'coin-amount': $('input[name="coin-amount-' + i + '"]').val(),
              'coin-price': $('input[name="coin-price-' + i + '"]').val()
            });
          }
          data.levelsData = levelsData;
          return data;
        };
        var loadDataSets = function() {
          var dataSetNames = localStorage.getItem('mySaveNames');
          if (dataSetNames === null) {
            dataSetNames = [];
          } else {
            dataSetNames = JSON.parse(dataSetNames);
          }
          $('select#data-sets-list').empty();
          $('select#data-sets-list').append('<option value="">New</option>');
          for (var i = 0; i < dataSetNames.length; i++) {
            $('select#data-sets-list').append('<option value="' + dataSetNames[i] + '">' + dataSetNames[i] + '</option>');
          }
        };
        var saveDataSet = function(saveName) {
          if (saveName.length === 0) {
            $('div.alert').text('Please enter a name for this save').show();
          } else {
            $('div.alert').hide();
          }
          var state = captureFormState();
          try {
            var mySaves = localStorage.getItem('mySaves');
            var mySaveNames = localStorage.getItem('mySaveNames');
            if (mySaves === null) {
              mySaves = {};
            } else {
              mySaves = JSON.parse(mySaves);
            }
            if (mySaveNames === null) {
              mySaveNames = [];
            } else {
              mySaveNames = JSON.parse(mySaveNames);
            }
            mySaves[saveName] = state;
            mySaveNames.push(saveName);
            localStorage.setItem('mySaves', JSON.stringify(mySaves));
            localStorage.setItem('mySaveNames', JSON.stringify(mySaveNames));
            loadDataSets();
          } catch (e) {
            $('div.alert').text(e.message).show();
          }
        };
        $('#save-button').on('click', function(e) {
          var saveName = $('#save-name').val();
          saveDataSet(saveName);
        });
        var loadDataSet = function(saveName) {
          var mySaves = localStorage.getItem('mySaves');
          if (mySaves === null) {
            mySaves = {};
          } else {
            mySaves = JSON.parse(mySaves);
          }
          var mySave = mySaves[saveName];
          if (typeof mySave !== 'undefined') {
            $('#initial-amount').val(mySave['initial-amount']);
            $('#initial-price').val(mySave['initial-price']);
            $('#projected-profit').val(mySave['projected-profit']);
            $('#levels').val(mySave['levels']);
            levelsHandler();
            for (var i = 0; i < parseInt(mySave['levels']); i++) {
              $('input[name="coin-amount-' + (i + 1) + '"]').val(mySave['levelsData'][i]['coin-amount']);
              $('input[name="coin-price-' + (i + 1) + '"]').val(mySave['levelsData'][i]['coin-price']);
            }
          } else {
            $('#initial-amount').val('');
            $('#initial-price').val('');
            $('#projected-profit').val('');
            $('#levels').val(1);
          }
          levelsHandler();
          calculate();
        };
        var deleteDataSet = function(saveName) {
          var mySaves = localStorage.getItem('mySaves');
          var mySaveNames = localStorage.getItem('mySaveNames');
          if (mySaves === null) {
            mySaves = {};
          } else {
            mySaves = JSON.parse(mySaves);
          }
          if (mySaveNames === null) {
            mySaveNames = [];
          } else {
            mySaveNames = JSON.parse(mySaveNames);
          }
          if (typeof mySaves[saveName] !== 'undefined') {
            delete mySaves[saveName];
          }
          if (mySaveNames.indexOf(saveName) > -1) {
            mySaveNames.splice(mySaveNames.indexOf(saveName), 1)
          }
          localStorage.setItem('mySaves', JSON.stringify(mySaves));
          localStorage.setItem('mySaveNames', JSON.stringify(mySaveNames));
          loadDataSets();
        };
        $('#load-data-set').on('click', function(e) {
          var saveName = $('select#data-sets-list').val();
          loadDataSet(saveName);
        });
        $('#delete-data-set').on('click', function(e) {
          var saveName = $('select#data-sets-list').val();
          deleteDataSet(saveName);
        });
        $(document).on('change', 'input[type="text"]', function(e) {
          calculate();
        });
        levelsHandler();
        loadDataSets();
      });
    </script>
    <style>
      img.va-top {
        vertical-align: top;
      }
    </style>
  </body>
</html>
